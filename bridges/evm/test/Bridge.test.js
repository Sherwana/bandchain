const { expectRevert } = require("openzeppelin-test-helpers");
const Bridge = artifacts.require("BridgeMock");
const ReceiverMock = artifacts.require("ReceiverMock");

require("chai").should();

contract("Bridge", ([_, owner, alice, bob]) => {
  context("Checking oracle state relay (4 validators)", () => {
    beforeEach(async () => {
      this.bridge = await Bridge.new(
        [
          ["0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5", 100],
          ["0x88e1cd00710495EEB93D4f522d16bC8B87Cb00FE", 100],
          ["0xaAA22E077492CbaD414098EBD98AA8dc1C7AE8D9", 100],
          ["0xB956589b6fC5523eeD0d9eEcfF06262Ce84ff260", 100],
        ],
        { from: owner },
      );
    });

    it("should accept correct state relay (validator power is more than 2/3)", async () => {
      await this.bridge.relayOracleState(
        "63407", // _blockHeight,
        [
          "0x2B14E5AB19A88F23B3F6C694659374DF21E21935A7C0B8565C4E7B43AAB3BB43", // accToMemCapStoresMerkleHash
          "0x06223635C7D081E76F30998DA7D601AB9AB8602C9AE7095E319C68F4CE2F5F73", // mintStoresMerkleHash
          "0xC744B497E2569517AA2F053E2A4E09C67427DC0FD8840048C607AF8F17D9100C", // oracleIAVLStateHash
          "0xAE658B0EA9B1C87323D0FA810ADBE9DB91BE0BAEA62D29F376488666ECA9BBEB", // paramsAndSlashingStoresMerkleHash
          "0xAA66B682A3FE96C372A095A43F2E73B33E89D835DB3BBF2496546328A7BD4961", // stakingAndUpgradeStoresMerkleHash
        ],
        [
          "0x32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E", // versionAndChainIdHash
          "0x9F667F22196CFEBD590E3B178148942EF40C5B693336BF20608D5F21AA679ABC", // timeHash
          "0xF665C04557D07EAACFC46F2E5B5D267C3B2C4EEAF395784F30CC84266816A89D", // lastBlockIDAndOther
          "0xE3BB39F3B621939B734AF396D7CF5CCFDEDD4A3D16F139FD481874BC6F6E52B4", // nextValidatorHashAndConsensusHash
          "0x6E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D", // lastResultsHash
          "0xD991DA4D4E69473CC75A4B819F9E07D4956671A6F4A74DF4CC16596FCBE68137", // evidenceAndProposerHash
        ],
        "0x6E080211AFF700000000000022480A20", // _signedDataPrefix
        [
          [
            "0x62A900783D67A397A0CE36C82108122B97ACF88034CA917209937E2FF29EDB1C", // r
            "0x378595FF3223971F63946D133DE29189497BC800F26370AF44512DDC3B02A1F1", // s
            27, // v
            "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F50510D1E2E19103320962616E64636861696E", // signedDataSuffix
          ],
          [
            "0x97009E1695FBD0FA6708C08C31EF92D28FA1AC64C6E6346193DE375AD377DE44", // r
            "0x54DB42DFE62EC6B2C755DB707D7DF48EF49485EF8282C91054B728F052E452AC", // s
            28, // v
            "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F5051084A2F89103320962616E64636861696E", // signedDataSuffix
          ],
          [
            "0x950C0D5475AB4D2E7257811A4F304201D6CC52F7F5D06B8CDBB53922C4BCD140", // r
            "0x4C747F4985569E59401E450F12F37933AED9EB9FB2F20CF022DAC9D31B9AADDC", // s
            28, // v
            "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F505109685E29103320962616E64636861696E", // signedDataSuffix
          ],
        ],
      );
    });

    it("should revert if sum of validator powers is less than 2/3)", async () => {
      await expectRevert(
        this.bridge.relayOracleState(
          "63407", // _blockHeight,
          [
            "0x2B14E5AB19A88F23B3F6C694659374DF21E21935A7C0B8565C4E7B43AAB3BB43", // accToMemCapStoresMerkleHash
            "0x06223635C7D081E76F30998DA7D601AB9AB8602C9AE7095E319C68F4CE2F5F73", // mintStoresMerkleHash
            "0xC744B497E2569517AA2F053E2A4E09C67427DC0FD8840048C607AF8F17D9100C", // oracleIAVLStateHash
            "0xAE658B0EA9B1C87323D0FA810ADBE9DB91BE0BAEA62D29F376488666ECA9BBEB", // paramsAndSlashingStoresMerkleHash
            "0xAA66B682A3FE96C372A095A43F2E73B33E89D835DB3BBF2496546328A7BD4961", // stakingAndUpgradeStoresMerkleHash
          ],
          [
            "0x32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E", // versionAndChainIdHash
            "0x9F667F22196CFEBD590E3B178148942EF40C5B693336BF20608D5F21AA679ABC", // timeHash
            "0xF665C04557D07EAACFC46F2E5B5D267C3B2C4EEAF395784F30CC84266816A89D", // lastBlockIDAndOther
            "0xE3BB39F3B621939B734AF396D7CF5CCFDEDD4A3D16F139FD481874BC6F6E52B4", // nextValidatorHashAndConsensusHash
            "0x6E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D", // lastResultsHash
            "0xD991DA4D4E69473CC75A4B819F9E07D4956671A6F4A74DF4CC16596FCBE68137", // evidenceAndProposerHash
          ],
          "0x6E080211AFF700000000000022480A20", // _signedDataPrefix
          [
            [
              "0x97009E1695FBD0FA6708C08C31EF92D28FA1AC64C6E6346193DE375AD377DE44", // r
              "0x54DB42DFE62EC6B2C755DB707D7DF48EF49485EF8282C91054B728F052E452AC", // s
              28, // v
              "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F5051084A2F89103320962616E64636861696E", // signedDataSuffix
            ],
            [
              "0x950C0D5475AB4D2E7257811A4F304201D6CC52F7F5D06B8CDBB53922C4BCD140", // r
              "0x4C747F4985569E59401E450F12F37933AED9EB9FB2F20CF022DAC9D31B9AADDC", // s
              28, // v
              "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F505109685E29103320962616E64636861696E", // signedDataSuffix
            ],
          ],
        ),
        "INSUFFICIENT_VALIDATOR_SIGNATURES",
      );
    });

    it("should not accept out-of-order signatures", async () => {
      await expectRevert(
        this.bridge.relayOracleState(
          "63407", // _blockHeight,
          [
            "0x2B14E5AB19A88F23B3F6C694659374DF21E21935A7C0B8565C4E7B43AAB3BB43", // accToMemCapStoresMerkleHash
            "0x06223635C7D081E76F30998DA7D601AB9AB8602C9AE7095E319C68F4CE2F5F73", // mintStoresMerkleHash
            "0xC744B497E2569517AA2F053E2A4E09C67427DC0FD8840048C607AF8F17D9100C", // oracleIAVLStateHash
            "0xAE658B0EA9B1C87323D0FA810ADBE9DB91BE0BAEA62D29F376488666ECA9BBEB", // paramsAndSlashingStoresMerkleHash
            "0xAA66B682A3FE96C372A095A43F2E73B33E89D835DB3BBF2496546328A7BD4961", // stakingAndUpgradeStoresMerkleHash
          ],
          [
            "0x32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E", // versionAndChainIdHash
            "0x9F667F22196CFEBD590E3B178148942EF40C5B693336BF20608D5F21AA679ABC", // timeHash
            "0xF665C04557D07EAACFC46F2E5B5D267C3B2C4EEAF395784F30CC84266816A89D", // lastBlockIDAndOther
            "0xE3BB39F3B621939B734AF396D7CF5CCFDEDD4A3D16F139FD481874BC6F6E52B4", // nextValidatorHashAndConsensusHash
            "0x6E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D", // lastResultsHash
            "0xD991DA4D4E69473CC75A4B819F9E07D4956671A6F4A74DF4CC16596FCBE68137", // evidenceAndProposerHash
          ],
          "0x6E080211AFF700000000000022480A20", // _signedDataPrefix
          [
            [
              "0x950C0D5475AB4D2E7257811A4F304201D6CC52F7F5D06B8CDBB53922C4BCD140", // r
              "0x4C747F4985569E59401E450F12F37933AED9EB9FB2F20CF022DAC9D31B9AADDC", // s
              28, // v
              "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F505109685E29103320962616E64636861696E", // signedDataSuffix
            ],
            [
              "0x97009E1695FBD0FA6708C08C31EF92D28FA1AC64C6E6346193DE375AD377DE44", // r
              "0x54DB42DFE62EC6B2C755DB707D7DF48EF49485EF8282C91054B728F052E452AC", // s
              28, // v
              "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F5051084A2F89103320962616E64636861696E", // signedDataSuffix
            ],
            [
              "0x62A900783D67A397A0CE36C82108122B97ACF88034CA917209937E2FF29EDB1C", // r
              "0x378595FF3223971F63946D133DE29189497BC800F26370AF44512DDC3B02A1F1", // s
              27, // v
              "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F50510D1E2E19103320962616E64636861696E", // signedDataSuffix
            ],
          ],
        ),
        "INVALID_SIGNATURE_SIGNER_ORDER",
      );
    });

    it("should not accept invalid signature", async () => {
      await expectRevert(
        this.bridge.relayOracleState(
          "63407", // _blockHeight,
          [
            "0x2B14E5AB19A88F23B3F6C694659374DF21E21935A7C0B8565C4E7B43AAB3BB43", // accToMemCapStoresMerkleHash
            "0x06223635C7D081E76F30998DA7D601AB9AB8602C9AE7095E319C68F4CE2F5F73", // mintStoresMerkleHash
            "0xC744B497E2569517AA2F053E2A4E09C67427DC0FD8840048C607AF8F17D9100C", // oracleIAVLStateHash
            "0xAE658B0EA9B1C87323D0FA810ADBE9DB91BE0BAEA62D29F376488666ECA9BBEB", // paramsAndSlashingStoresMerkleHash
            "0xAA66B682A3FE96C372A095A43F2E73B33E89D835DB3BBF2496546328A7BD4961", // stakingAndUpgradeStoresMerkleHash
          ],
          [
            "0x32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E", // versionAndChainIdHash
            "0x9F667F22196CFEBD590E3B178148942EF40C5B693336BF20608D5F21AA679ABC", // timeHash
            "0xF665C04557D07EAACFC46F2E5B5D267C3B2C4EEAF395784F30CC84266816A89D", // lastBlockIDAndOther
            "0xE3BB39F3B621939B734AF396D7CF5CCFDEDD4A3D16F139FD481874BC6F6E52B4", // nextValidatorHashAndConsensusHash
            "0x6E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D", // lastResultsHash
            "0xD991DA4D4E69473CC75A4B819F9E07D4956671A6F4A74DF4CC16596FCBE68137", // evidenceAndProposerHash
          ],
          "0x6E080211AFF700000000000022480A20", // _signedDataPrefix
          [
            [
              // This sigature is wrong
              "0x62A900783D67A397A0CE36C82108122B97ACF88034CA917209937E2FF29EDB1C", // r
              "0x378595FF3223971F63946D133DE29189497BC800F26370AF44512DDC3B02A1F1", // s
              28, // v
              "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F50510D1E2E19103320962616E64636861696E", // signedDataSuffix
            ],
            [
              "0x97009E1695FBD0FA6708C08C31EF92D28FA1AC64C6E6346193DE375AD377DE44", // r
              "0x54DB42DFE62EC6B2C755DB707D7DF48EF49485EF8282C91054B728F052E452AC", // s
              28, // v
              "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F5051084A2F89103320962616E64636861696E", // signedDataSuffix
            ],
            [
              "0x950C0D5475AB4D2E7257811A4F304201D6CC52F7F5D06B8CDBB53922C4BCD140", // r
              "0x4C747F4985569E59401E450F12F37933AED9EB9FB2F20CF022DAC9D31B9AADDC", // s
              28, // v
              "0x12240A205F339FD218803D4B7BCBEC09FB24D1BCEAE0938FA20FD028C2993D9731690CBB10012A0C08DFD6A0F505109685E29103320962616E64636861696E", // signedDataSuffix
            ],
          ],
        ),
        "INSUFFICIENT_VALIDATOR_SIGNATURES",
      );
    });
  });

  context("Checking data verification", () => {
    beforeEach(async () => {
      this.bridge = await Bridge.new([]);
      await this.bridge.setOracleState(
        "1447", // _blockHeight
        "0xD9381E1FF03917811C175418F8E00D8C73A3EAA353BF90D67ACF93A43146D341", // _oracleIAVLStateHash
      );
    });

    it("should not accept unrelayed block", async () => {
      await expectRevert(
        this.bridge.verifyOracleData(
          "999999", // _blockHeight
          ["beeb", 1, "0x030000004254436400000000000000", 4, 4], // _requestPacket
          ["beeb", 6, 4, 1589711543, 1589711547, 1, "0xa8860e0000000000"], // _responsePacket
          "14235", // _version
          [
            [
              true, // isDataOnRight
              "1", // subtreeHeight
              "2", // subtreeSize
              "14235", // subtreeVersion
              "0x31B53AC6BE8A11EF93E218CFE492A5B68D1D4479FCE3E13529514BE8E5DFB133", // siblingHash
            ],
            [
              true, // isDataOnRight
              "2", // subtreeHeight
              "4", // subtreeSize
              "14235", // subtreeVersion
              "0x89C052A44451DC7D5B05694D67F869F83C6EEC75B2106578A0834CD18D3F5CAE", // siblingHash
            ],
            [
              true, // isDataOnRight
              "3", // subtreeHeight
              "8", // subtreeSize
              "14235", // subtreeVersion
              "0x77BB51D79817F54DB42F6F6CEF184DF7226610B64B5599871B8058CC4A3FF6F6", // siblingHash
            ],
            [
              true, // isDataOnRight
              "4", // subtreeHeight
              "12", // subtreeSize
              "14235", // subtreeVersion
              "0xFECF29346BE7E49B838B1DF61584B3A357CBF348BA1F95BF25177CAAE4ED1A79", // siblingHash
            ],
            [
              true, // isDataOnRight
              "5", // subtreeHeight
              "20", // subtreeSize
              "14235", // subtreeVersion
              "0x11F8545EC7A18BACB1FDA550BB31BBACC1B56CE78369B738D75D129B91E73091", // siblingHash
            ],
            [
              true, // isDataOnRight
              "6", // subtreeHeight
              "45", // subtreeSize
              "14236", // subtreeVersion
              "0x94F8DC46C64E4E4A32E6D2A5A67557D83CEA9212CD47ED673A58C1A81D7969D8", // siblingHash
            ],
          ],
        ),
        "NO_ORACLE_ROOT_STATE_DATA",
      );
    });

    it("should accept correct data verification", async () => {
      const ret = await this.bridge.verifyOracleData(
        "1447", // _blockHeight
        ["test", 1, "0x030000004254436400000000000000", 4, 4], // _requestPacket
        ["test", 4, 4, 1590744852, 1590744857, 1, "0xd46c0e0000000000"], // _responsePacket
        "1426", // _version
        [
          [
            true, // isDataOnRight
            "1", // subtreeHeight
            "2", // subtreeSize
            "1426", // subtreeVersion
            "0xF47CBAE57D4FBE07F6DDB0B90287579F34477B5320B37760D5C4EA572FCEF2FC", // siblingHash
          ],
          [
            true, // isDataOnRight
            "2", // subtreeHeight
            "3", // subtreeSize
            "1426", // subtreeVersion
            "0x06D44912BC01B36ABC29FE9EC01137B806C7A8367E1CB6160D911E0996E75682", // siblingHash
          ],
          [
            true, // isDataOnRight
            "3", // subtreeHeight
            "7", // subtreeSize
            "1443", // subtreeVersion
            "0x5E5FAC882D52EE59650A505840B40C7B052EDD5093E838586A9FD01ED53E2D11", // siblingHash
          ],
          [
            true, // isDataOnRight
            "4", // subtreeHeight
            "11", // subtreeSize
            "1443", // subtreeVersion
            "0x85FD34BB633BDACCB43DA136594C2570E86091B8696336F993455C4831AB6278", // siblingHash
          ],
          [
            true, // isDataOnRight
            "5", // subtreeHeight
            "18", // subtreeSize
            "1443", // subtreeVersion
            "0xFAEAD3EB63723791ED5C58CECADC5080E1D9A6554C8A263B0D1798C7C8DF0D56", // siblingHash
          ],
          [
            true, // isDataOnRight
            "6", // subtreeHeight
            "26", // subtreeSize
            "1443", // subtreeVersion
            "0x3FA2246DCC9DC2971670EF8D6CB283D9BBB364C84E3302EAD738798D0B9A0C2C", // siblingHash
          ],
          [
            true, // isDataOnRight
            "7", // subtreeHeight
            "58", // subtreeSize
            "1446", // subtreeVersion
            "0x71902BBBFACAC8DA79C62FE9BC4C0057FE6BBDA847A6FB8464F4D43D38E7E131", // siblingHash
          ],
        ],
      );
      ret[0]
        .toString()
        .should.eq(
          ["test", 1, "0x030000004254436400000000000000", 4, 4].toString(),
        );
      ret[1]
        .toString()
        .should.eq(
          [
            "test",
            4,
            4,
            1590744852,
            1590744857,
            1,
            "0xd46c0e0000000000",
          ].toString(),
        );
    });

    it("should not accept invalid data verification", async () => {
      await expectRevert(
        this.bridge.verifyOracleData(
          "1447", // _blockHeight
          ["wrong id", 1, "0x030000004254436400000000000000", 4, 4], // _requestPacket
          ["test", 4, 4, 1590744852, 1590744857, 1, "0xd46c0e0000000000"], // _responsePacket
          "1426", // _version
          [
            [
              true, // isDataOnRight
              "1", // subtreeHeight
              "2", // subtreeSize
              "1426", // subtreeVersion
              "0xF47CBAE57D4FBE07F6DDB0B90287579F34477B5320B37760D5C4EA572FCEF2FC", // siblingHash
            ],
            [
              true, // isDataOnRight
              "2", // subtreeHeight
              "3", // subtreeSize
              "1426", // subtreeVersion
              "0x06D44912BC01B36ABC29FE9EC01137B806C7A8367E1CB6160D911E0996E75682", // siblingHash
            ],
            [
              true, // isDataOnRight
              "3", // subtreeHeight
              "7", // subtreeSize
              "1443", // subtreeVersion
              "0x5E5FAC882D52EE59650A505840B40C7B052EDD5093E838586A9FD01ED53E2D11", // siblingHash
            ],
            [
              true, // isDataOnRight
              "4", // subtreeHeight
              "11", // subtreeSize
              "1443", // subtreeVersion
              "0x85FD34BB633BDACCB43DA136594C2570E86091B8696336F993455C4831AB6278", // siblingHash
            ],
            [
              true, // isDataOnRight
              "5", // subtreeHeight
              "18", // subtreeSize
              "1443", // subtreeVersion
              "0xFAEAD3EB63723791ED5C58CECADC5080E1D9A6554C8A263B0D1798C7C8DF0D56", // siblingHash
            ],
            [
              true, // isDataOnRight
              "6", // subtreeHeight
              "26", // subtreeSize
              "1443", // subtreeVersion
              "0x3FA2246DCC9DC2971670EF8D6CB283D9BBB364C84E3302EAD738798D0B9A0C2C", // siblingHash
            ],
            [
              true, // isDataOnRight
              "7", // subtreeHeight
              "58", // subtreeSize
              "1446", // subtreeVersion
              "0x71902BBBFACAC8DA79C62FE9BC4C0057FE6BBDA847A6FB8464F4D43D38E7E131", // siblingHash
            ],
          ],
        ),
        "INVALID_ORACLE_DATA_PROOF",
      );
    });

    it("should not accept incomplete proof", async () => {
      await expectRevert(
        this.bridge.verifyOracleData(
          "1447", // _blockHeight
          ["test", 1, "0x030000004254436400000000000000", 4, 4], // _requestPacket
          ["test", 4, 4, 1590744852, 1590744857, 1, "0xd46c0e0000000000"], // _responsePacket
          "1426", // _version
          [
            [
              true, // isDataOnRight
              "1", // subtreeHeight
              "2", // subtreeSize
              "1426", // subtreeVersion
              "0xF47CBAE57D4FBE07F6DDB0B90287579F34477B5320B37760D5C4EA572FCEF2FC", // siblingHash
            ],
            [
              true, // isDataOnRight
              "2", // subtreeHeight
              "3", // subtreeSize
              "1426", // subtreeVersion
              "0x06D44912BC01B36ABC29FE9EC01137B806C7A8367E1CB6160D911E0996E75682", // siblingHash
            ],
            [
              true, // isDataOnRight
              "3", // subtreeHeight
              "7", // subtreeSize
              "1443", // subtreeVersion
              "0x5E5FAC882D52EE59650A505840B40C7B052EDD5093E838586A9FD01ED53E2D11", // siblingHash
            ],
            [
              true, // isDataOnRight
              "4", // subtreeHeight
              "11", // subtreeSize
              "1443", // subtreeVersion
              "0x85FD34BB633BDACCB43DA136594C2570E86091B8696336F993455C4831AB6278", // siblingHash
            ],
            [
              true, // isDataOnRight
              "5", // subtreeHeight
              "18", // subtreeSize
              "1443", // subtreeVersion
              "0xFAEAD3EB63723791ED5C58CECADC5080E1D9A6554C8A263B0D1798C7C8DF0D56", // siblingHash
            ],
            [
              true, // isDataOnRight
              "6", // subtreeHeight
              "26", // subtreeSize
              "1443", // subtreeVersion
              "0x3FA2246DCC9DC2971670EF8D6CB283D9BBB364C84E3302EAD738798D0B9A0C2C", // siblingHash
            ],
          ],
        ),
        "INVALID_ORACLE_DATA_PROOF",
      );
    });
  });

  context("Relay and Verfiy data", () => {
    beforeEach(async () => {
      this.bridge = await Bridge.new([
        ["0x88e1cd00710495EEB93D4f522d16bC8B87Cb00FE", 100],
        ["0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5", 100],
        ["0xB956589b6fC5523eeD0d9eEcfF06262Ce84ff260", 100],
        ["0xaAA22E077492CbaD414098EBD98AA8dc1C7AE8D9", 100],
      ]);

      this.receiver = await ReceiverMock.new(this.bridge.address);
    });

    it("should accept valid relay and verify", async () => {
      await this.receiver.relayAndSafe(
        "0x00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000004EA33F9D1AFD5F4A3FCEEEC2CE1F8D9D82C584263D5E47DE53B14852AD2AF3A0FCA359BE285070CDCCA267BF38B97F41CD0D657B8FB5DB22A88A0321030851A5CB09AF8B31EA4FFD387796033C1C9FFD2026CC992604C35D6ECADBBF6EE02EE7BDFE1B1079A59C885D887696346155C2721164317B31935AF4E47340A2C97B93C940480F5A289DBB2F91546E3FFC32CE69B956C0C16398EDD5A30EB9413862190C832FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869EFA90F366CE9298A98C32EEB59F0F366355DF9070C1C454C1DBEB1FD272D2AA5F8969FAD39231D16B8114F4A6F7B6BA6C086CECDAC838358043D335A51D7C74F3004209A161040AB1778E2F2C00EE482F205B28EFBA439FCB04EA283F619478D96E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D7F4BE7E5A1EB872AD44103360DDC190410331280C42A54D829A5D752C796685D00000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000106E080211EA0400000000000022480A200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000002206820D7A06F28902048903DD442711783C853AB40B10BF46336397B0BBBCAEA1F201ECE6B51FEED07759978F8DA1B143E6CDC9570599F4F449A511E1D13CCE15A000000000000000000000000000000000000000000000000000000000000001B0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A20932A82CEEC3F3612A3768D3C6BA909C3E8FCFB797AD63DD375F7499DDCB3989510012A0C08FEABC3F605108CC1A8AD03320962616E64636861696E002A788DE8F641991A035D5A14BCC29AE7FF507D61E925C34ADB6F7B900F319FE70DEFBF439631A59796CFD199C33B9CD297FB096B5B38ECBDF3E779146401DAE0000000000000000000000000000000000000000000000000000000000000001B0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A20932A82CEEC3F3612A3768D3C6BA909C3E8FCFB797AD63DD375F7499DDCB3989510012A0C08FEABC3F60510E8E084CD03320962616E64636861696E00FA22D420BC02CC4801195823ADCEAA81761DDE75AA9230E01615867C1281002E0F0F3F8B19E2D84644E601146B59EF57FFFF122D23EDB459A627112AA27EBD1D000000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A20932A82CEEC3F3612A3768D3C6BA909C3E8FCFB797AD63DD375F7499DDCB3989510012A0C08FEABC3F60510A0BDEFBB03320962616E64636861696E00000000000000000000000000000000000000000000000000000000000000076000000000000000000000000000000000000000000000000000000000000004EA00000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001A000000000000000000000000000000000000000000000000000000000000004D600000000000000000000000000000000000000000000000000000000000002E000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008040000006661737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000005ED0D5D9000000000000000000000000000000000000000000000000000000005ED0D5DC00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000086801000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000004D606D44912BC01B36ABC29FE9EC01137B806C7A8367E1CB6160D911E0996E7568200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000004E8B629F3758505F5595DFA3FA14AB0B1005974F1AC1F1B50A825BE1DE57098509C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000004E881ADED41BD60DAC8C182133108C6CE330C3610D3A942E7233FDFCFEB4067AD0900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000A00000000000000000000000000000000000000000000000000000000000004E86B0CEE6765A83623962D52B4B14124939A49722554123BDBDE3A3F78D27E19B900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001100000000000000000000000000000000000000000000000000000000000004E8FAEAD3EB63723791ED5C58CECADC5080E1D9A6554C8A263B0D1798C7C8DF0D5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001900000000000000000000000000000000000000000000000000000000000004E83FA2246DCC9DC2971670EF8D6CB283D9BBB364C84E3302EAD738798D0B9A0C2C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000003900000000000000000000000000000000000000000000000000000000000004E94347B85A92B7384833F103F4FEC5B3CB70872296F748F93F07521474C3AD5CB7",
      );
      (await this.bridge.oracleStates(1258))
        .toString()
        .should.eq(
          "0x9af8b31ea4ffd387796033c1c9ffd2026cc992604c35d6ecadbbf6ee02ee7bdf",
        );
      const req = await this.receiver.latestReq();
      req[0].toString().should.eq("");
      req[1].toString().should.eq("8");
      req[2].toString().should.eq("0x0400000066617374");
      req[3].toString().should.eq("3");
      req[4].toString().should.eq("4");
      const res = await this.receiver.latestRes();
      res[0].toString().should.eq("");
      res[1].toString().should.eq("3");
      res[2].toString().should.eq("3");
      res[3].toString().should.eq("1590744537");
      res[4].toString().should.eq("1590744540");
      res[5].toString().should.eq("1");
      res[6].toString().should.eq("0x6801000000000000");
    });

    it("should accept valid relay and verify case 2", async () => {
      await this.receiver.relayAndSafe(
        "0x00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005A76C7AA01EBEEDECE408C8EFCE7BAB9AD6F71A725BB6285411C90E6D202648F83F13B7C470C712F4CF53FDE2E8FD91A3E48F1E6773BF1489823F8B88D9787737E0D9381E1FF03917811C175418F8E00D8C73A3EAA353BF90D67ACF93A43146D341918E3FEF625AE058246E0C0580FB75758C536927127F316FB8C2F908E17656AA841167FA8C388F2C9EE6D4C51747E328B6B012B783E08F28356D15FC362DCC3E32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E294C9FBD9112E7A65863058586A6ED2B50EE1CFF552F150B04C270682DEE9006E57A402468238120D3B81F543508CF7D736F99058CC1581013AA3EF38FE454FC004209A161040AB1778E2F2C00EE482F205B28EFBA439FCB04EA283F619478D96E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01DD991DA4D4E69473CC75A4B819F9E07D4956671A6F4A74DF4CC16596FCBE6813700000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000106E080211A70500000000000022480A2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000022085DCAD6C0B2AA43EB4C1CFE6D4575F62AA4F10F5514217D9964E1D5C94734B953528A74101877330978CFC3ADE20CA2B9B2C4F2984DC873D514CC0FACD834595000000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A20E4174178832A1F9344D6F14CE64CB07E14FC57260C83E947F25C40CD9D96BBE910012A0C08BCAEC3F60510B48EEFBF01320962616E64636861696E004885CD00F629063D61E2993299E62919429465AD58245E2CE62CBE9E172DA9A2418BBCC0286EBAC9D8D2A4A232EB1750860E0FB0881FAC10517C6364E9F9F8C8000000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A20E4174178832A1F9344D6F14CE64CB07E14FC57260C83E947F25C40CD9D96BBE910012A0C08BCAEC3F605108C9EE2B701320962616E64636861696E00A9DF1FA37B403729BC4A43367CED4F6A7FEC43031687B613CFF9FCC16CB8ACC3280AA7C9CABD34CAE1AF1E3E82423C1A6E56D6523CADBA248CE3722D2C293D6A000000000000000000000000000000000000000000000000000000000000001B0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A20E4174178832A1F9344D6F14CE64CB07E14FC57260C83E947F25C40CD9D96BBE910012A0C08BCAEC3F6051080A0B0A101320962616E64636861696E0000000000000000000000000000000000000000000000000000000000000007A000000000000000000000000000000000000000000000000000000000000005A700000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001C00000000000000000000000000000000000000000000000000000000000000592000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000E00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000047465737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F030000004254436400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ED0D714000000000000000000000000000000000000000000000000000000005ED0D71900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000474657374000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008D46C0E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000592F47CBAE57D4FBE07F6DDB0B90287579F34477B5320B37760D5C4EA572FCEF2FC000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000059206D44912BC01B36ABC29FE9EC01137B806C7A8367E1CB6160D911E0996E7568200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000005A35E5FAC882D52EE59650A505840B40C7B052EDD5093E838586A9FD01ED53E2D1100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000B00000000000000000000000000000000000000000000000000000000000005A385FD34BB633BDACCB43DA136594C2570E86091B8696336F993455C4831AB627800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000005A3FAEAD3EB63723791ED5C58CECADC5080E1D9A6554C8A263B0D1798C7C8DF0D5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001A00000000000000000000000000000000000000000000000000000000000005A33FA2246DCC9DC2971670EF8D6CB283D9BBB364C84E3302EAD738798D0B9A0C2C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000003A00000000000000000000000000000000000000000000000000000000000005A671902BBBFACAC8DA79C62FE9BC4C0057FE6BBDA847A6FB8464F4D43D38E7E131",
      );
      (await this.bridge.oracleStates(1447))
        .toString()
        .should.eq(
          "0xd9381e1ff03917811c175418f8e00d8c73a3eaa353bf90d67acf93a43146d341",
        );
      const req = await this.receiver.latestReq();
      req[0].toString().should.eq("test");
      req[1].toString().should.eq("1");
      req[2].toString().should.eq("0x030000004254436400000000000000");
      req[3].toString().should.eq("4");
      req[4].toString().should.eq("4");
      const res = await this.receiver.latestRes();
      res[0].toString().should.eq("test");
      res[1].toString().should.eq("4");
      res[2].toString().should.eq("4");
      res[3].toString().should.eq("1590744852");
      res[4].toString().should.eq("1590744857");
      res[5].toString().should.eq("1");
      res[6].toString().should.eq("0xd46c0e0000000000");
    });

    it("should revert invalid relay and verify", async () => {
      await expectRevert(
        this.receiver.relayAndSafe(
          "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000234A4AFD853694C8D904E7509C4E388D054D7FECA188CC2AA5F391CE2DE0C1DF753CE9D9F07EEB72C23C2F1DD0D8A19DE627686089917A7E5E8E22FF604DBD6E94BA198FCFAEBF1A6F499B330699B61C2557E8CCAEECDE3AEDD50192AAF87245E166D5B21D67B07D553861AD2BCA87CAE74491965249C30D248902F35AD90B9511C0AB8335CB1AD62163B743379D7292B32401F658713424DDADD38C3232F0224AF32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E49E1A01E4A705DAFCAD7013CB6A86D2D5505ED76D8F1665CFBBE279FFE000638FFD6B03A759B769DCAD0D02F9DE45A9CC546F947573C108414D456F1A7116059004209A161040AB1778E2F2C00EE482F205B28EFBA439FCB04EA283F619478D96E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D0EFE3E12F46363C7779140D4CE659925DB52F19053E114D7CC4EFD666B37F79F00000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000106E080211340200000000000022480A200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000002200E103975CA4DFB90BB0E5A5C091767945978E3EBAB28735A83E8DAD09CA5F6913CA0A40EA5112DCD8A2E4B4E7871F095CB243BD91619090D01494396EEB7A611000000000000000000000000000000000000000000000000000000000000001B0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A2060ACC88D982DE2F0B60C7EC7B084B358EB33EFBD3B1F7CB78A07692DAAE5429F10012A0C08AC92A6F50510CCF58EB801320962616E64636861696E00CCC447AF4AB179B0CAF4F25BD5DDC5AC59E9F9D9F4BAA939CCB54CC8FBA643E674A2DA90D06869302F7790F36B7559C84A7702F35E7DE0096991756C42CC65B7000000000000000000000000000000000000000000000000000000000000001B0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A2060ACC88D982DE2F0B60C7EC7B084B358EB33EFBD3B1F7CB78A07692DAAE5429F10012A0C08AC92A6F50510EFE7E1B801320962616E64636861696E0090B7F346F8B2BF847CD4D05740A54FB73AB42C5D0190BF4E0795F2289C6489527EE33A5ED014E401361F29A84FC1708EA0FCE74D66FA2A0EE6D3CBE636585ADB000000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A2060ACC88D982DE2F0B60C7EC7B084B358EB33EFBD3B1F7CB78A07692DAAE5429F10012A0C08AC92A6F50510A1CFCBB801320962616E64636861696E000000000000000000000000000000000000000000000000000000000000000660000000000000000000000000000000000000000000000000000000000000023400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001C00000000000000000000000000000000000000000000000000000000000000231000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000E00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000057465737432000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E303330303030303034323534343336343030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005EA98920000000000000000000000000000000000000000000000000000000005EA9892600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000574657374320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010653661313063303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000231F281D7270823933196D3AE4B0C418E92034944CA4E5972BA3A16D5260DC962500000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000231D1814868AB070BE64030D05681EBBAA8394251D3FD3A677AA839233CA6EC1C9D000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000023148EAD2DE2ED08B9E45637904A213B3A92BB90C5F70D89E3EBEE8A369DA6C25AB0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000231709E1C73511B24EFDD9B8D3CD717A5210BA20E2411A8529E8B642C54FB002DC400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000002336A7D1D56C342E6C24F69FE1CEEAE5D6F8BBDE2AC9A101F40FEBBA2CDFEB69C4A",
        ),
        "RELAY_ORACLE_STATE_FAILED.",
      );

      await expectRevert(
        this.receiver.relayAndSafe(
          "0x0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000000234E4AFD853694C8D904E7509C4E388D054D7FECA188CC2AA5F391CE2DE0C1DF753CE9D9F07EEB72C23C2F1DD0D8A19DE627686089917A7E5E8E22FF604DBD6E94BA198FCFAEBF1A6F499B330699B61C2557E8CCAEECDE3AEDD50192AAF87245E166D5B21D67B07D553861AD2BCA87CAE74491965249C30D248902F35AD90B9511C0AB8335CB1AD62163B743379D7292B32401F658713424DDADD38C3232F0224AF32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E49E1A01E4A705DAFCAD7013CB6A86D2D5505ED76D8F1665CFBBE279FFE000638FFD6B03A759B769DCAD0D02F9DE45A9CC546F947573C108414D456F1A7116059004209A161040AB1778E2F2C00EE482F205B28EFBA439FCB04EA283F619478D96E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D0EFE3E12F46363C7779140D4CE659925DB52F19053E114D7CC4EFD666B37F79F00000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000106E080211340200000000000022480A200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000002200E103975CA4DFB90BB0E5A5C091767945978E3EBAB28735A83E8DAD09CA5F6913CA0A40EA5112DCD8A2E4B4E7871F095CB243BD91619090D01494396EEB7A611000000000000000000000000000000000000000000000000000000000000001B0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A2060ACC88D982DE2F0B60C7EC7B084B358EB33EFBD3B1F7CB78A07692DAAE5429F10012A0C08AC92A6F50510CCF58EB801320962616E64636861696E00CCC447AF4AB179B0CAF4F25BD5DDC5AC59E9F9D9F4BAA939CCB54CC8FBA643E674A2DA90D06869302F7790F36B7559C84A7702F35E7DE0096991756C42CC65B7000000000000000000000000000000000000000000000000000000000000001B0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A2060ACC88D982DE2F0B60C7EC7B084B358EB33EFBD3B1F7CB78A07692DAAE5429F10012A0C08AC92A6F50510EFE7E1B801320962616E64636861696E0090B7F346F8B2BF847CD4D05740A54FB73AB42C5D0190BF4E0795F2289C6489527EE33A5ED014E401361F29A84FC1708EA0FCE74D66FA2A0EE6D3CBE636585ADB000000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000003F12240A2060ACC88D982DE2F0B60C7EC7B084B358EB33EFBD3B1F7CB78A07692DAAE5429F10012A0C08AC92A6F50510A1CFCBB801320962616E64636861696E000000000000000000000000000000000000000000000000000000000000000660000000000000000000000000000000000000000000000000000000000000023400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001C00000000000000000000000000000000000000000000000000000000000000231000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000E00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000057465737432000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E303330303030303034323534343336343030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005EA98920000000000000000000000000000000000000000000000000000000005EA9892600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000574657374320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010653661313063303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000231F281D7270823933196D3AE4B0C418E92034944CA4E5972BA3A16D5260DC962500000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000231D1814868AB070BE64030D05681EBBAA8394251D3FD3A677AA839233CA6EC1C9D000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000023148EAD2DE2ED08B9E45637904A213B3A92BB90C5F70D89E3EBEE8A369DA6C25AB0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000231709E1C73511B24EFDD9B8D3CD717A5210BA20E2411A8529E8B642C54FB002DC400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000002336A7D1D56C342E6C24F69FE1CEEAE5D6F8BBDE2AC9A101F40FEBBA2CDFEB69B4A",
        ),
        "VERIFY_ORACLE_DATA_FAILED.",
      );
    });
  });

  context("Update provider powers", () => {
    beforeEach(async () => {
      this.bridge = await Bridge.new(
        [
          ["0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5", 100],
          ["0x88e1cd00710495EEB93D4f522d16bC8B87Cb00FE", 100],
          ["0xaAA22E077492CbaD414098EBD98AA8dc1C7AE8D9", 100],
          ["0xB956589b6fC5523eeD0d9eEcfF06262Ce84ff260", 100],
        ],
        { from: owner },
      );
    });

    it("should revert if update validator power by non-onwer", async () => {
      await expectRevert(
        this.bridge.updateValidatorPowers(
          [["0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5", 150]],
          {
            from: alice,
          },
        ),
        "Ownable: caller is not the owner.",
      );
    });

    it("should update a validator power", async () => {
      await this.bridge.updateValidatorPowers(
        [["0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5", 150]],
        { from: owner },
      );

      (
        await this.bridge.validatorPowers(
          "0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5",
        )
      )
        .toString()
        .should.eq("150");

      (await this.bridge.totalValidatorPower()).toString().should.eq("450");
    });

    it("should update validator powers", async () => {
      await this.bridge.updateValidatorPowers(
        [
          ["0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5", 150],
          ["0x88e1cd00710495EEB93D4f522d16bC8B87Cb00FE", 0],
          ["0x85109F11A7E1385ee826FbF5dA97bB97dba0D76f", 200],
        ],
        { from: owner },
      );

      (
        await this.bridge.validatorPowers(
          "0x652D89a66Eb4eA55366c45b1f9ACfc8e2179E1c5",
        )
      )
        .toString()
        .should.eq("150");

      (
        await this.bridge.validatorPowers(
          "0x88e1cd00710495EEB93D4f522d16bC8B87Cb00FE",
        )
      )
        .toString()
        .should.eq("0");

      (
        await this.bridge.validatorPowers(
          "0x85109F11A7E1385ee826FbF5dA97bB97dba0D76f",
        )
      )
        .toString()
        .should.eq("200");

      (await this.bridge.totalValidatorPower()).toString().should.eq("550");
    });
  });
});
